<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background: #1F2544;
            margin: 0;
        }

        .server-column {
            fill: #1F2544;
        }

        .tableRect {
            stroke-width: 2;
            font-weight: 300;
        }

        .tableName {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
        }
    </style>
</head>

<body>
    <svg id="system"></svg>

    <script>
        var servers = ["WEB", "WAS", "DB"];
        var requests = [
            { id: "req1", name: 'service1', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 1000, state: [], status: 'normal' },
            { id: "req2", name: 'service2', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 1000, state: [], status: 'warning' },
            { id: "req3", name: 'service3', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 9000, state: [], status: 'normal' },
            { id: "req4", name: 'service4', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 8400, state: [], status: 'error' },
            { id: "req5", name: 'service5', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 5000, state: [], status: 'normal' },
            { id: "req6", name: 'service6', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 2000, state: [], status: 'error' },
            { id: "req7", name: 'service7', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 4000, state: [], status: 'warning' },
            { id: "req8", name: 'service8', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 7000, state: [], status: 'error' },
            { id: "req9", name: 'service9', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 8000, state: [], status: 'warning' },
            { id: "req10", name: 'service10', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 4400, state: [], status: 'normal' },
            { id: "req11", name: 'service11', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 3200, state: [], status: 'warning' },
            { id: "req12", name: 'service12', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 7240, state: [], status: 'normal' },
            { id: "req13", name: 'service13', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 7240, state: [], status: 'normal' },
            { id: "req14", name: 'service14', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 3500, state: [], status: 'warning' },
            { id: "req15", name: 'service15', actions: ['register', 'WEBWAS', 'WASDB', 'DBWAS', 'WASWEB', 'ungister'], time: 2400, state: [], status: 'error' },
        ];

        requests.sort((a, b) => a.time - b.time);

        let width = 1800;
        let height = 580;
        let timerID;
        let stateIdCounter = 0;
        let errorTablesCount = 0;

        for (var i = 0; i < requests.length; i++) {
            if (requests[i].status === 'error') {
                errorTablesCount++;
            }
        }

        var svg = d3.select("#system")
            .attr("width", width)
            .attr("height", height)
            .append("g");

        const filter = svg.append("defs")
            .append("filter")
            .attr("id", "drop-shadow")
            .attr("x", "-50%")
            .attr("y", "-50%")
            .attr("width", "200%")
            .attr("height", "200%");

        filter.append("feComponentTransfer")
            .attr("in", "SourceAlpha")
            .append("feFuncA")
            .attr("type", "table")
            .attr("tableValues", "1 0");

        filter.append("feGaussianBlur")
            .attr("stdDeviation", 30);

        filter.append("feOffset")
            .attr("dx", 0)
            .attr("dy", 0)
            .attr("result", "offsetblur");

        filter.append("feFlood")
            .attr("flood-color", "#7BD3EA")
            .attr("result", "color");

        filter.append("feComposite")
            .attr("in2", "offsetblur")
            .attr("operator", "in");

        filter.append("feComposite")
            .attr("in2", "SourceAlpha")
            .attr("operator", "in");

        const feMerge = filter.append("feMerge");
        feMerge.append("feMergeNode")
            .attr("in", "SourceGraphic");
        feMerge.append("feMergeNode")
            .attr("in", "comp");


        svg.selectAll(".server-column2")
            .data(servers)
            .enter().append("circle")
            .attr("class", "server-column2")

            .attr("cx", function (d, i) {
                return i * (width / servers.length) + ((width / servers.length)) / 2 + 50;
            })
            .attr("r", 220)
            .attr("width", 1000 / servers.length)
            .attr("height", 320)
            .transition()
            .duration(500)
            .style("filter", "drop-shadow(0px 0px 15px #7BD3EA)")
            .style("opacity", 0)
            .attr("cy", -100)
            .transition()
            .duration(1200)
            .delay(function (d, i) {
                return i * 1000;
            })
            .style("opacity", 1)
            .attr("cy", 230)


        svg.selectAll(".server-column")
            .data(servers)
            .enter().append("circle")
            .attr("class", "server-column")

            .attr("cx", function (d, i) {
                return i * (width / servers.length) + ((width / servers.length)) / 2 + 50;
            })
            .attr("r", 220)
            .attr("width", 1000 / servers.length)
            .attr("height", 320)
            .attr("stroke", "#7BD3EA")
            .attr("stroke-width", 2)
            .transition()
            .duration(500)
            .style("opacity", 0)
            .attr("cy", -100)
            .transition()
            .duration(1200)
            .delay(function (d, i) {
                return i * 1000;
            })
            .style("filter", "url(#drop-shadow)")
            .style("opacity", 1)
            .attr("cy", 230)


        var totalAnimationTime = requests.reduce(function (sum, request) {
            return Math.max(sum, request.time + 4000);
        }, 0);

        function checkAndUpdateStatus(request) {
            if (request.time > totalAnimationTime) {
                request.status = 'error';
            }
        }

        requests.forEach(checkAndUpdateStatus);

        if (timerID) {
            clearInterval(timerID);
        }


        setTimeout(function () {
            if (errorTablesCount >= 4) {
                var warningIcon = svg.selectAll(".warning")
                    .data(servers)
                    .enter().append("image")
                    .attr("class", "warning")
                    .attr("xlink:href", function (d) {
                        return "./img/warning.png";
                    })
                    .attr("x", function (d, i) {
                        return i * (width / servers.length) + ((width / servers.length)) / 2 - 210;
                    })
                    .attr("y", -50)
                    .attr("width", 150)
                    .attr("height", 150)
                    .attr("filter", "drop-shadow(2px 4px 6px red)")
                    .style("opacity", 1);


                timerID = setInterval(function () {
                    warningIcon.transition().duration(500)
                        .style("opacity", warningIcon.style("opacity") === "1" ? 0.5 : 1);
                }, 500);
            }
        }, totalAnimationTime);


        svg.selectAll(".server-image")
            .data(servers)
            .enter().append("image")
            .attr("class", "server-image")
            .attr("xlink:href", function (d) {
                return "./img/attr.png";
            })
            .attr("x", function (d, i) {
                return i * (width / servers.length) + ((width / servers.length)) / 2 - 210;
            })
            .attr("y", 100)
            .attr("width", 500)
            .attr("height", 500)


        svg.selectAll(".text-server")
            .data(servers)
            .enter().append("text")
            .attr('class', 'textserver')
            .attr("x", function (d, i) {
                return i * (width / servers.length) + ((width / servers.length)) / 2 + 28;
            })
            .attr("y", 40)
            .style("font-size", "20px")
            .attr("font-weight", 700)
            .style("fill", "#ffffff")
            .transition()
            .duration(500)
            .style("opacity", 0)
            .transition()
            .duration(1200)
            .delay(function (d, i) {
                return i * 1500;
            })
            .style("filter", "url(#drop-shadow)")
            .style("opacity", 1)
            .text(d => d);


        // ===============================================


        function performAction(action, currentServer) {
            switch (action) {
                case "register":
                    return 'WEB';
                case "WEBWAS":
                    return "WAS";
                case "WASDB":
                    return "DB";
                case "DBWAS":
                    return "WAS";
                case "WASWEB":
                    return "WEB";
                case "ungister":
                    if (currentServer === "WEB") {
                        return "ungister";
                    }
                    return "WEB";
                default:
                    return null;
            }
        }

        function getColor(status) {
            switch (status) {
                case 'normal':
                    return '#00A9FF';
                case 'warning':
                    return 'orange';
                case 'error':
                    return 'red';
                default:
                    return '#00A9FF';
            }
        }

        function getFilter(status) {
            switch (status) {
                case 'normal':
                    return "hue-rotate(180deg)";
                case 'warning':
                    return "hue-rotate(0deg)";
                case 'error':
                    return "hue-rotate(320deg)";
                default:
                    return "hue-rotate(180deg)";
            }
        }

        function getImageUrl(currentServer, nextServer) {
            if (currentServer === "DB" && nextServer === "WAS") {
                return "./img/rocket11.png";
            } else if (currentServer === "WAS" && nextServer === "WEB") {
                return "./img/rocket11.png";
            } else if (currentServer === "WEB" && nextServer === "ungister") {
                return "./img/rocket11.png";
            }
            else {
                return "./img/rocket.png";
            }
        }

        function getMargin(currentServer, nextServer) {
            if (currentServer === "DB" && nextServer === "WAS") {
                return "./img/rocket11.png";
            } else if (currentServer === "WAS" && nextServer === "WEB") {
                return "./img/rocket11.png";
            } else if (currentServer === "WEB" && nextServer === "ungister") {
                return "./img/rocket11.png";
            }
            else {
                return "./img/rocket.png";
            }
        }

        function triggerExplosion(left, top, width, height, requestId, status) {
            var explosionClass = "explosion-" + requestId;
            d3.selectAll("." + explosionClass).remove();
            var explosionImage = d3.select("body").append("img")
                .attr("class", "explosion " + explosionClass)
                .attr("src", "./img/explotion.gif")
                .style("position", "absolute")
                .style("width", "80px")
                .style("filter", getFilter(status))
                .style("left", (left + width / 2 - 40) + "px")
                .style("top", (top + height / 2 - 60) + "px")
                .style("display", "block");
            explosionImage.transition()
                .duration(500)
                .on("end", function () {
                    explosionImage.style("display", "none");
                });
        }

        // ===============================================

        var outerGroupElement = svg.append('g').attr("id", "outerGroup");

        function moveRequest(request, index, actionIndex) {

            var requestImage = svg.select("#" + request.id);
            var requestText = svg.select("#text_" + request.id);

            var currentIndex = servers.indexOf(request.current);
            var currentServer = request.current;
            var action = request.actions[actionIndex];
            var nextServer = performAction(action, currentServer);
            var nextIndex = servers.indexOf(nextServer);
            var targetCircle = nextIndex * (width / servers.length) + (width / servers.length) / 2;
            var targetRect = nextIndex * (width / servers.length) + (width / servers.length) / 2;

            var imageUrl = getImageUrl(request.current, nextServer);

            var groupElement = outerGroupElement.append('g')
                .attr("id", "rectTable")
                .attr("transform", function () {
                    var row = Math.floor(index / 3);
                    var col = index % 3;
                    var translateX = col * 95;
                    var translateY = row * 60;
                    return "translate(" + translateX + "," + translateY + ")";
                });


            requestText.transition()
                .duration(2000)
                .delay(request.time)
                .attr("x", targetCircle - 50)
                .transition()
                .duration(0)
                .style("opacity", 1);

            requestImage.transition()
                .duration(2000)
                .delay(request.time)
                .attr("xlink:href", imageUrl)
                .attr("x", targetCircle - 30)
                .attr("y", 80)
                .transition()
                .duration(0)
                .style("opacity", 1)
                .on("end", function () {
                    if (currentIndex < nextIndex) {
                        stateIdCounter++;
                        var stateId = "state_" + stateIdCounter;
                        request.state.push(stateId);

                        groupElement.append("rect")
                            .attr("id", stateId)
                            .attr("class", "tableRect")
                            .attr("x", targetRect - 80)
                            .attr("y", 80)
                            .attr("width", 80)
                            .attr("height", 50)
                            .transition()
                            .duration(1000)
                            .style("fill", getColor(request.status))
                            .style("fill-opacity", 0.3)
                            .style("filter", "drop-shadow(0px 0px 10px " + getColor(request.status) + ")")
                            .style("stroke", getColor(request.status))


                        if (request.status === 'error') {
                            timerID = setInterval(function () {
                                d3.select("#" + stateId)
                                    .transition()
                                    .duration(150)
                                    .style("opacity", 0.5)
                                    .style("filter", "drop-shadow(0px 0px 0px " + getColor(request.status) + ")")
                                    .transition()
                                    .duration(150)
                                    .style("filter", "drop-shadow(0px 0px 15px " + getColor(request.status) + ")")
                                    .style("opacity", 1);
                            }, 500);
                        }

                        groupElement.append('text')
                            .attr('id', stateId)
                            .attr('class', 'tableName')
                            .attr("x", targetRect - 40)
                            .attr("y", 110)
                            .transition()
                            .duration(1000)
                            .style("font-size", "20px")
                            .text(request.name);
                    }

                    request.current = nextServer;

                    // ===============================================

                    if (request.current === "DB") {
                        request.next = "WAS";
                    } else if (request.current === "WAS") {
                        if (currentIndex < nextIndex) {
                            request.next = "DB";
                        } else {
                            request.next = "WEB";
                            var lastStateId = request.state.pop();
                            var lastStateElement = svg.select("#" + lastStateId);
                            var lastStateRect = lastStateElement.node().getBoundingClientRect();
                            lastStateElement.remove();

                            svg.selectAll("#" + lastStateId).remove();
                            triggerExplosion(lastStateRect.left, lastStateRect.top, lastStateRect.width, lastStateRect.height, request.id, request.status);
                        }
                    } else if (request.current === "WEB") {
                        if (currentIndex < nextIndex) {
                            request.next = "WAS";
                        } else {
                            request.next = "DB";
                            var lastStateId = request.state.pop();
                            var lastStateElement = svg.select("#" + lastStateId);
                            var lastStateRect = lastStateElement.node().getBoundingClientRect();
                            lastStateElement.remove();

                            svg.selectAll("#" + lastStateId).remove();
                            triggerExplosion(lastStateRect.left, lastStateRect.top, lastStateRect.width, lastStateRect.height, request.id, request.status);
                        }
                    }
                    else if (request.current === "ungister") {
                        if (currentIndex < nextIndex) {
                            request.next = "WEB";

                        } else {
                            request.next = "WAS";
                            var lastStateId = request.state.pop();
                            var lastStateElement = svg.select("#" + lastStateId);
                            var lastStateRect = lastStateElement.node().getBoundingClientRect();
                            lastStateElement.remove();

                            svg.selectAll("#" + lastStateId).remove();
                            triggerExplosion(lastStateRect.left, lastStateRect.top, lastStateRect.width, lastStateRect.height, request.id, request.status);
                        }
                    }

                    // ===============================================

                    if (actionIndex < request.actions.length - 1) {
                        moveRequest(request, index, actionIndex + 1);

                    } else {
                        requestText.transition()
                            .duration(0)
                            .style("opacity", 0);
                        requestImage.transition()
                            .duration(0)
                            .style("opacity", 0);

                        setTimeout(function () {
                            moveRequest(requests[index], index, 0);
                        }, 2000);
                    }
                });
        }

        var circleGroupElement = svg.insert('g', ':first-child').attr("id", "circleGroup");

        requests.forEach(function (request, index) {
            var circlegroupElement = circleGroupElement.append('g')
                .attr("id", "circleTable")
                .attr("transform", function () {
                    var row = Math.floor(index / 3);
                    var col = index % 3;
                    var translateX = col * 80;
                    var translateY = row * 60;
                    return "translate(" + translateX + "," + translateY + ")";
                });


            circlegroupElement.append("image")
                .attr("id", request.id)
                .attr("xlink:href", "./img/rocket.png")
                .attr("x", -50)
                .attr("y", 70)
                .attr("width", 50)
                .attr("height", 50)
                .style("opacity", 0)
                .style("filter", "drop-shadow(2px 4px 15px #F9F54B)")


            circlegroupElement.append('text')
                .attr('id', 'text_' + request.id)
                .attr('class', 'circleText')
                .attr('x', 0)
                .attr('y', 75)
                .attr('fill', 'white')
                .style("font-size", "18px")
                .attr('text-anchor', 'start')
                .style("opacity", 0)
                .text(request.name);
            moveRequest(request, index, 0);
        });
    </script>

</body>

</html>